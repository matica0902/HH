
# 1.1  宣告CASE類別

程序說明:
Step 1.宣告CASE類別 ResultSchema1 並定義有哪些參數 預作使用SCALA中可以使用SQL TABLE的準備
Step 2.宣告CASE類別 ResultSchema2 並定義有哪些參數 預作使用SCALA中可以使用SQL TABLE的準備


規則說明:
case class ResultSchema1(PKGNO:String, STATUSA2:String, STATUSB1:String, STATUSB2:String, PROC_DATEA:String, PROC_TIMEA:String, 
PROC_DTA:String, PROC_BRHA:String, PROC_DATEB:String, PROC_TIMEB:String, PROC_DTB:String, PROC_BRHB:String, PKGVALUE:String, 
PKGCOLL:String, PKGWEIGHT:String, PKGPOST:String, CONTRACTNO1:String, CONTRACTNO2:String, DESTZIPCODE:String, 
DESTZIPCODE_LEN:Int, PROC_YMA:String, PROC_YMB:String)
//宣告ResultSchema1 類別,並分別定義22個參數命名與型別皆為字串

案例
依照case class 形成SCHEMA1
+-----+--------+--------+--------+----------+----------+--------+---------+----------+----------+--------+---------+--------+---
|PKGNO|STATUSA2|STATUSB1|STATUSB2|PROC_DATEA|PROC_TIMEA|PROC_DTA|PROC_BRHA|PROC_DATEB|PROC_TIMEB|PROC_DTB|PROC_BRHB|PKGVALUE|PKG
+-----+--------+--------+--------+----------+----------+--------+---------+----------+----------+--------+---------+--------+---


----+---------+-------+-----------+-----------+-----------+---------------+--------+--------+
COLL|PKGWEIGHT|PKGPOST|CONTRACTNO1|CONTRACTNO2|DESTZIPCODE|DESTZIPCODE_LEN|PROC_YMA|PROC_YMB|

規則說明:
case class ResultSchema2(PKGNO:String, PROC_H:String, REASON:String, REC_BRH:String, REC_BRH_TEL:String, HOURS:Float)
//宣告ResultSchema2 類別分別定義6個參數命名與型別為字串與浮點數.

案例


# 1.2  宣告函數

程序說明:

Step 1.定義gettimeStamp()取得時間戳記
Step 2.定義getSortValue()將資料排序
Step 3.定義getRecord()取得資料並去空值
Step 4 定義getHours()取得時間並轉換成小時為單位


規則說明:
def getTimeStamp(s:String):Timestamp={
//定義取得時間戳記方法,輸入變數字串回傳Timestamp,

  val format = new SimpleDateFormat("yyyy-MM-ddHH:mm:ss")
  //宣告變數format 並實作SimpleDateFormat方法
    
  val d = format.parse(s)
  //宣告變數 d  並傳入字串s後使用parse方法轉換格式
    
  val t = new Timestamp(d.getTime())
  //宣告變數 t  並實作Timestamp帶入變數d.getTime()方法取得時間字串
    
  return t
  
  //回傳 變數t 的Timestamp 值
  
    }
    
    
    
    

規則說明:
def getSortValue(v:Iterable[String]):String={val l = v.toList.sorted; return l(0)}









規則說明:
def getRecord(r:(String, List[String])):Option[List[String]]={
      val res = r._2.find(s => s.slice(0, 0+13) > r._1.slice(0, 0+13))
      if (res.isDefined) {Some(List(r._1, res.get))} else None
    }
    
    
    
    
    
    
    
規則說明:
def getHours(b:String, e:String):String={ val h = "%.2f".format((e.toDouble-b.toDouble)/1000/3600); return h }






產出







 
 









產出

Y4908947730037708800082016-10-0211:39:51880580      591                                 
I4908947730037708800082016-10-0213:22:04880580                                          
Y4912794730038709740002016-10-0206:28:47970015      406                                 
I4912794730038709740002016-10-0212:28:46970015                                          
Y401061673003978      2016-10-0211:37:01950009      341                                 
I401061673003978      2016-10-0212:14:29950009                                          
Y401061873003978      2016-10-0211:37:48950009      341                                 
H401061873003978      2016-10-0212:13:55950009012                                       
Z455731200102870      2016-10-0121:10:200918144006727959                                
Z455731200102870      2016-10-0203:08:514006725000381338                                
Y455731200102870      2016-10-0207:03:00500038      194                                 
I455731200102870      2016-10-0215:40:39500038                                          
Y455737600102870      2016-10-0213:10:30100250      438                                 
P556346500102870      2016-10-0208:54:54900064                                          
Z457150300102870      2016-10-0119:08:420918142206032631                                
Y458309600102870      2016-10-0209:23:56880580      464                                 
I458309600102870      2016-10-0214:02:29880580                                          
Z459302400102870      2016-10-0122:00:170918148305832737  



+-----+--------+--------+--------+----------+----------+--------+---------+----------+----------+--------+---------+--------+---
|PKGNO|STATUSA2|STATUSB1|STATUSB2|PROC_DATEA|PROC_TIMEA|PROC_DTA|PROC_BRHA|PROC_DATEB|PROC_TIMEB|PROC_DTB|PROC_BRHB|PKGVALUE|PKG
+-----+--------+--------+--------+----------+----------+--------+---------+----------+----------+--------+---------+--------+---


----+---------+-------+-----------+-----------+-----------+---------------+--------+--------+
COLL|PKGWEIGHT|PKGPOST|CONTRACTNO1|CONTRACTNO2|DESTZIPCODE|DESTZIPCODE_LEN|PROC_YMA|PROC_YMB|
----+---------+-------+-----------+--------
# 1.3  讀取檔案資料


程序說明	

Step1.讀入所有資料符合pkgCodeLst條件資料存入 val a
Step2.過濾val a 中符合紀錄字首為A之資料並計算其時間戳記,並以郵件編號為鍵值groupBY前後時間紀錄為同一筆紀錄後存入val akv
Step3.過濾val a 中符合紀錄字首為H或I之資料並計算其時間戳記,並以郵件編號為鍵值groupBY前後時間紀錄為同一筆紀錄後存入val akv



規則說明:
val a = sc.textFile(inDir).filter(r => pkgCodeLst.contains(r.slice(14,14+2))).cache()
//  從inDir讀取檔案 過濾[郵件狀態代碼]slice(14,14+2) 存入RDD 其中過濾條件為pkgCodeLst中的元素 

案例
I401061673003978      2016-10-0212:14:29950009  
H401061873003978      2016-10-0212:13:55950009012 
Y455731200102870      2016-10-0207:03:00500038      194                                 
I455731200102870      2016-10-0215:40:39500038                                          
Y455737600102870      2016-10-0213:10:30100250      438                                 
P556346500102870      2016-10-0208:54:54900064           







規則說明:
val akv = a.filter(r => r.matches("^A.*")).distinct()
// 濾出首位字元H或I的紀錄  並做distinct()消去重複紀錄

.map(r => (r.slice(2,2+20), "%s%s".format(getTimeStamp(r.slice(22,22+18)).getTime().toString,r)))
//將每筆紀錄的[郵件號碼]slice(2,2+20)map成key-value2的Key 
 並對[處理時間],[處理日期] slice(22,22+18)map成key-value的value後,做getTimeStamp()取得時間戳記
 
.groupByKey().mapValues(getSortValue(_))

//最後以[郵件號碼]對KEY-VALUE做groupBy,且使用mapValue()將KEY-VALUE中的VALUE排序


案例
val a 原始紀錄值

H425740000101170      2016-10-0113:18:13900056012                                                          
H425740000101170      2016-10-0213:24:06900056012         

val hikv (STEP1)
先將 a.filter().map()形成  (K,V)=(郵件編號,時間戳記+val a原始紀錄值)

(25740000101170,  1475353093000     H425740000101170   2016-10-0113:18:13900056012)  (K1,V1)
(25740000101170,  1475439846000     H425740000101170   2016-10-0213:24:06900056012)  (K1,V2)
                
(說明): 1475353093000為getTimeStamp(2016-10-0113:18:13900056012)所計算出的時間戳記  

val hikv (STEP2)
再groupByKey 後排序

val hikv2=     (K1,List(V1,V2))
(25740000101170  
,List(1475353093000H425740000101170  2016-10-0113:18:13900056012 1475439846000H425740000101170 2016-10-0213:24:06900056012 ))













規則說明:
val hikv = a.filter(r => (r.matches("^H.*") || r.matches

("^I.*"))).distinct()
// 濾出首位字元H或I的紀錄  並做distinct()

.map(r => (r.slice(2,2+20), "%s%s".format(getTimeStamp(r.slice(22,22+18)).getTime().toString,r)))
//將每筆紀錄的郵件號碼slice(2,2+20)map成key-value2的Key 
 將slice(22,22+18)map成key-value的value ,並對時間日期做getTimeStamp()取得時間戳記
  
.groupByKey).mapValues(_.toList.sorted) 

//以郵件號碼對 KEY-VALUE  做groupBy,後將KEY-VALUE 中的VALUE排序


案例
val a 原始紀錄值

H425740000101170      2016-10-0113:18:13900056012                                                          
H425740000101170      2016-10-0213:24:06900056012         

val hikv (STEP1)
先將 a.filter().map()形成  (K,V)=(郵件編號,時間戳記+val a原始紀錄值)

(25740000101170,  1475353093000     H425740000101170   2016-10-0113:18:13900056012)  (K1,V1)
(25740000101170,  1475439846000     H425740000101170   2016-10-0213:24:06900056012)  (K1,V2)
                
(說明): 1475353093000為getTimeStamp(2016-10-0113:18:13900056012)所計算出的時間戳記  

val hikv (STEP2)
再groupByKey 後排序

val hikv2=     (K1,List(V1,V2))
(25740000101170  
,List(1475353093000H425740000101170  2016-10-0113:18:13900056012 1475439846000H425740000101170 2016-10-0213:24:06900056012 ))










產出

17/11/17 22:50:26 INFO DAGScheduler: ResultStage 5 (collect at playgun.scala:51) finished in 0.456 s
17/11/17 22:50:26 INFO DAGScheduler: Job 1 finished: collect at playgun.scala:51, took 1.702727 s
17/11/17 22:50:26 INFO TaskSetManager: Finished task 0.0 in stage 5.0 (TID 5) in 459 ms on localhost (1/1)
17/11/17 22:50:26 INFO TaskSchedulerImpl: Removed TaskSet 5.0, whose tasks have all completed, from pool 
(14567210009178      ,List(1475430936000I414567210009178      2016-10-0210:55:36730039                                        ))
(15587900101870      ,List(1475441285000I415587900101870      2016-10-0213:48:05880580                                        ))
(55587300102270      ,List(1475451039000I455587300102270      2016-10-0216:30:39880580                                        ))
(05914000102470      ,List(1475439724000I405914000102470      2016-10-0213:22:04880580                                        ))
(15662600101470      ,List(1475429286000I415662600101470      2016-10-0210:28:06970029                                        ))
(57410910000070      ,List(1475440798000I457410910000070      2016-10-0213:39:58730039                                        ))
(39142980000070      ,List(1475451039000I439142980000070      2016-10-0216:30:39880580                                        ))
(76103500103170      ,List(1475449066000I476103500103170      2016-10-0215:57:46880580                                        ))
(15107050000070      ,List(1475427231000I415107050000070      2016-10-0209:53:51540017                                        ))
(82672400103570      ,List(1475439269000I482672400103570      2016-10-0213:14:29880580                                        ))
(92738610015570880000,List(1475449108000I4927386100155708800002016-10-0215:58:28880580                                        ))
(61803600102970      ,List(1475439785000I461803600102970      2016-10-0213:23:05880580                                        ))
(96119350000170880004,List(1475449066000I4961193500001708800042016-10-0215:57:46880580                                        ))
(87774524128178      ,List(1475451039000I487774524128178      2016-10-0216:30:39880580                                        ))
(61803400102970      ,List(1475439785000I461803400102970      2016-10-0213:23:05880580                                        ))
(01229822204178      ,List(1475442822000I401229822204178      2016-10-0214:13:42100998                                        ))
(02184010014878      ,List(1475449017000I402184010014878      2016-10-0215:56:57880580                                        ))
(33232000102370      ,List(1475429514000I433232000102370      2016-10-0210:31:54540040                                        ))
(01946800101170      ,List(1475449028000H401946800101170      2016-10-0215:57:08880580012                                     ))
(97956370402070530005,List(1475425334000I4979563704020705300052016-10-0209:22:14500058                                        ))
(67122100103770      ,List(1475434146000I467122100103770      2016-10-0211:49:06540009                                        ))


```python
+--------------------+--------+--------+--------+-------------------+----------+-------------------+---------+-------------------+----------+-------------------+---------+--------+-------+---------+-------+-----------+-----------+-----------+------+------+-------+-----------+-----+---------------+--------+--------+
|               PKGNO|STATUSA2|STATUSB1|STATUSB2|         PROC_DATEA|PROC_TIMEA|           PROC_DTA|PROC_BRHA|         PROC_DATEB|PROC_TIMEB|           PROC_DTB|PROC_BRHB|PKGVALUE|PKGCOLL|PKGWEIGHT|PKGPOST|CONTRACTNO1|CONTRACTNO2|DESTZIPCODE|PROC_H|REASON|REC_BRH|REC_BRH_TEL|HOURS|DESTZIPCODE_LEN|PROC_YMA|PROC_YMB|
+--------------------+--------+--------+--------+-------------------+----------+-------------------+---------+-------------------+----------+-------------------+---------+--------+-------+---------+-------+-----------+-----------+-----------+------+------+-------+-----------+-----+---------------+--------+--------+
|82562900103070      |       4|       H|       4|2016-10-02 00:00:00|  08:32:00|2016-10-02 08:32:00|   600028|2016-10-02 00:00:00|  12:36:38|2016-10-02 12:36:38|   880580|  000000| 000000|   000189| 000065|           |           |      116  |     0|    12|       |           | 4.08|              3|  201610|  201610|
|90958960002870      |       1|       I|       1|2016-10-02 00:00:00|  08:06:00|2016-10-02 08:06:00|   600028|2016-10-02 00:00:00|  15:56:59|2016-10-02 15:56:59|   880580|  000000| 000000|   000012| 000000|           |           |      10603|      |      |       |           | 7.85|              5|  201610|  201610|
+--------------------+--------+--------+--------+-------------------+----------+-------------------+---------+-------------------+----------+-------------------+---------+--------+-------+---------+-------+-----------+-----------+-----------+------+------+-------+-----------+-----+---------------+--------+--------+


```
